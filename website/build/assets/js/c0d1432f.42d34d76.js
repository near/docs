"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[5353],{98094:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>l,default:()=>b,frontMatter:()=>c,metadata:()=>u,toc:()=>h});var a=n(85893),s=n(11151),r=n(74866),i=n(85162),o=n(71183);const c={id:"sandbox-testing",title:"Sandbox Testing"},l=void 0,u={id:"tutorials/auction/sandbox-testing",title:"Sandbox Testing",description:"In the previous section, we went through the contract's code, analyzing how it worked. Now, we need to test it and make sure it works as expected! For contracts, there are two types of testing you can do: unit testing and sandbox testing.",source:"@site/../docs/3.tutorials/auction/1.2-testing.md",sourceDirName:"3.tutorials/auction",slug:"/tutorials/auction/sandbox-testing",permalink:"/tutorials/auction/sandbox-testing",draft:!1,unlisted:!1,editUrl:"https://github.com/near/docs/edit/master/website/../docs/3.tutorials/auction/1.2-testing.md",tags:[],version:"current",lastUpdatedBy:"Owen",lastUpdatedAt:1728641473e3,frontMatter:{id:"sandbox-testing",title:"Sandbox Testing"},sidebar:"tutorials",previous:{title:"Basic Auction",permalink:"/tutorials/auction/basic-auction"},next:{title:"Deploying to Testnet",permalink:"/tutorials/auction/deploy"}},d={},h=[{value:"Account Creation",id:"account-creation",level:2},{value:"Contract Initialization",id:"contract-initialization",level:2},{value:"Bidding",id:"bidding",level:2},{value:"Checking the balance",id:"checking-the-balance",level:4},{value:"Testing invalid calls",id:"testing-invalid-calls",level:4},{value:"Fast Forwarding Time",id:"fast-forwarding-time",level:2},{value:"Executing the tests",id:"executing-the-tests",level:2},{value:"Conclusion",id:"conclusion",level:2}];function p(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",h4:"h4",hr:"hr",p:"p",pre:"pre",strong:"strong",...(0,s.a)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(t.p,{children:"In the previous section, we went through the contract's code, analyzing how it worked. Now, we need to test it and make sure it works as expected! For contracts, there are two types of testing you can do: unit testing and sandbox testing."}),"\n",(0,a.jsx)(t.p,{children:"Here, we will focus on sandbox testing, as it enables one to deploy the contract in a realistic environment, allowing us to create multiple accounts and interact with the contract as if it was deployed on the blockchain."}),"\n",(0,a.jsx)(t.admonition,{title:"unit testing",type:"info",children:(0,a.jsx)(t.p,{children:"Unit tests are built into the language and are used to test the contract functions individually. These tests work well when little context is required. However, they cannot test chain interactions - like sending accounts $NEAR tokens - since they need to be processed by the network."})}),"\n",(0,a.jsx)(t.hr,{}),"\n",(0,a.jsx)(t.h2,{id:"account-creation",children:"Account Creation"}),"\n",(0,a.jsx)(t.p,{children:"The first thing our test does is to create multiple accounts with 10 $NEAR tokens each and deploy the contract to one of them."}),"\n",(0,a.jsxs)(r.Z,{groupId:"code-tabs",children:[(0,a.jsxs)(i.Z,{value:"js",label:"\ud83c\udf10 JavaScript",children:[(0,a.jsx)(o.Ey,{fname:"main.ava.js",language:"javascript",url:"https://github.com/near-examples/auctions-tutorial/blob/main/contract-ts/01-basic-auction/sandbox-test/main.ava.js#L12-L23",start:"12",end:"23"}),(0,a.jsxs)(t.p,{children:["To deploy the contract, we pass the path to the compiled WASM contract as an argument to the test in ",(0,a.jsx)(t.code,{children:"package.json"}),". Indeed, when executing ",(0,a.jsx)(t.code,{children:"npm run test"}),", the command will first compile the contract and then run the tests."]})]}),(0,a.jsxs)(i.Z,{value:"rust",label:"\ud83e\udd80 Rust",children:[(0,a.jsx)(o.Ey,{fname:"test_basics.rs",language:"rust",url:"https://github.com/near-examples/auctions-tutorial/blob/main/contract-rs/01-basic-auction/tests/test_basics.rs#L17-l29",start:"17",end:"29"}),(0,a.jsx)(t.p,{children:"Notice that the sandbox compiles the code itself, so we do not need to pre-compile the contract before running the tests."})]})]}),"\n",(0,a.jsx)(t.hr,{}),"\n",(0,a.jsx)(t.h2,{id:"contract-initialization",children:"Contract Initialization"}),"\n",(0,a.jsxs)(t.p,{children:["To initialize, the contract's account calls itself, invoking the ",(0,a.jsx)(t.code,{children:"init"})," function with an ",(0,a.jsx)(t.code,{children:"end_time"})," set to 60 seconds in the future."]}),"\n",(0,a.jsxs)(r.Z,{groupId:"code-tabs",children:[(0,a.jsxs)(i.Z,{value:"js",label:"\ud83c\udf10 JavaScript",children:[(0,a.jsx)(o.Ey,{fname:"main.ava.js",language:"javascript",url:"https://github.com/near-examples/auctions-tutorial/blob/main/contract-ts/01-basic-auction/sandbox-test/main.ava.js#L26-L29",start:"26",end:"29"}),(0,a.jsx)(t.admonition,{title:"Time Units",type:"warning",children:(0,a.jsxs)(t.p,{children:["The contract measures time in ",(0,a.jsx)(t.strong,{children:"nanoseconds"}),", for which we need to multiply the result of ",(0,a.jsx)(t.code,{children:"Date.now()"})," (expressed in milliseconds) by ",(0,a.jsx)(t.code,{children:"10^6"})]})})]}),(0,a.jsxs)(i.Z,{value:"rust",label:"\ud83e\udd80 Rust",children:[(0,a.jsx)(o.Ey,{fname:"test_basics.rs",language:"rust",url:"https://github.com/near-examples/auctions-tutorial/blob/main/contract-rs/01-basic-auction/tests/test_basics.rs#L31-L38",start:"31",end:"38"}),(0,a.jsx)(t.admonition,{title:"Time Units",type:"warning",children:(0,a.jsxs)(t.p,{children:["The contract measures time in ",(0,a.jsx)(t.strong,{children:"nanoseconds"}),", for which we need to multiply the result of ",(0,a.jsx)(t.code,{children:"Utc::now().timestamp()"})," (expressed in seconds) by ",(0,a.jsx)(t.code,{children:"10^9"})]})})]})]}),"\n",(0,a.jsx)(t.admonition,{title:"Time is a String",type:"info",children:(0,a.jsxs)(t.p,{children:["Notice that the time is passed as a ",(0,a.jsx)(t.code,{children:"String"})," to the contract, this is because smart contracts cannot receive numbers larger than ",(0,a.jsx)(t.code,{children:"52 bits"})," and we want to pass a ",(0,a.jsx)(t.code,{children:"unix timestamp"})," in ",(0,a.jsx)(t.strong,{children:"nanoseconds"})]})}),"\n",(0,a.jsx)(t.hr,{}),"\n",(0,a.jsx)(t.h2,{id:"bidding",children:"Bidding"}),"\n",(0,a.jsx)(t.p,{children:"Now that the contract is deployed and initialized, we can start bidding and checking if the contract behaves as expected."}),"\n",(0,a.jsxs)(t.p,{children:["We first make ",(0,a.jsx)(t.code,{children:"alice"})," place a bid of 1 NEAR, and check that the contract correctly registers the bid. Then, we have ",(0,a.jsx)(t.code,{children:"bob"})," place a bid of 2 NEAR, and check that the highest bid is updated, and that ",(0,a.jsx)(t.code,{children:"alice"})," gets her NEAR refunded."]}),"\n",(0,a.jsxs)(r.Z,{groupId:"code-tabs",children:[(0,a.jsx)(i.Z,{value:"js",label:"\ud83c\udf10 JavaScript",children:(0,a.jsx)(o.Ey,{fname:"main.ava.js",language:"javascript",url:"https://github.com/near-examples/auctions-tutorial/blob/main/contract-ts/01-basic-auction/sandbox-test/main.ava.js#L46-L61",start:"46",end:"61"})}),(0,a.jsx)(i.Z,{value:"rust",label:"\ud83e\udd80 Rust",children:(0,a.jsx)(o.Ey,{fname:"test_basics.rs",language:"rust",url:"https://github.com/near-examples/auctions-tutorial/blob/main/contract-rs/01-basic-auction/tests/test_basics.rs",start:"42",end:"74"})})]}),"\n",(0,a.jsx)(t.h4,{id:"checking-the-balance",children:"Checking the balance"}),"\n",(0,a.jsxs)(t.p,{children:["It is important to notice how we check if ",(0,a.jsx)(t.code,{children:"alice"})," was refunded. We query her balance after her first bid, and then check if it has increased by 1 NEAR after ",(0,a.jsx)(t.code,{children:"bob"})," makes his bid."]}),"\n",(0,a.jsxs)(t.p,{children:["You might be tempted to check if ",(0,a.jsx)(t.code,{children:"alice"}),"'s balance is exactly 10 NEAR after she gets refunded, but ",(0,a.jsx)(t.code,{children:"alice"})," balance cannot be 10 NEAR anymore, because some $NEAR was ",(0,a.jsxs)(t.strong,{children:["consumed as ",(0,a.jsx)(t.code,{children:"gas"})," fees"]})," when ",(0,a.jsx)(t.code,{children:"alice"})," called ",(0,a.jsx)(t.code,{children:"bid"}),"."]}),"\n",(0,a.jsx)(t.h4,{id:"testing-invalid-calls",children:"Testing invalid calls"}),"\n",(0,a.jsx)(t.p,{children:"When testing we should also check that the contract does not allow invalid calls. The next part checks that the contract doesn't allow for bids with fewer $NEAR tokens than the previous to be made."}),"\n",(0,a.jsxs)(r.Z,{groupId:"code-tabs",children:[(0,a.jsx)(i.Z,{value:"js",label:"\ud83c\udf10 JavaScript",children:(0,a.jsx)(o.Ey,{fname:"main.ava.js",language:"javascript",url:"https://github.com/near-examples/auctions-tutorial/blob/main/contract-ts/01-basic-auction/sandbox-test/main.ava.js#L64",start:"64",end:"64"})}),(0,a.jsx)(i.Z,{value:"rust",label:"\ud83e\udd80 Rust",children:(0,a.jsx)(o.Ey,{fname:"test_basics.rs",language:"rust",url:"https://github.com/near-examples/auctions-tutorial/blob/main/contract-rs/01-basic-auction/tests/test_basics.rs#L77-L83",start:"77",end:"83"})})]}),"\n",(0,a.jsx)(t.hr,{}),"\n",(0,a.jsx)(t.h2,{id:"fast-forwarding-time",children:"Fast Forwarding Time"}),"\n",(0,a.jsx)(t.p,{children:"The sandbox allows us to fast-forward time, which is useful for testing the contract when the auction is over. The test advances 200 blocks in order to pass a minute, and thus allowing the auction to be claimed."}),"\n",(0,a.jsx)(t.p,{children:"After which the auction can now be claimed. Once claimed the test checks that the auctioneer has received the correct amount of $NEAR tokens."}),"\n",(0,a.jsxs)(r.Z,{groupId:"code-tabs",children:[(0,a.jsx)(i.Z,{value:"js",label:"\ud83c\udf10 JavaScript",children:(0,a.jsx)(o.Ey,{fname:"main.ava.js",language:"javascript",url:"https://github.com/near-examples/auctions-tutorial/blob/main/contract-ts/01-basic-auction/sandbox-test/main.ava.js#L69-L81",start:"69",end:"81"})}),(0,a.jsx)(i.Z,{value:"rust",label:"\ud83e\udd80 Rust",children:(0,a.jsx)(o.Ey,{fname:"test_basics.rs",language:"rust",url:"https://github.com/near-examples/auctions-tutorial/blob/main/contract-rs/01-basic-auction/tests/test_basics.rs#L95-L112",start:"95",end:"112"})})]}),"\n",(0,a.jsx)(t.p,{children:"If you review the tests in full you'll see that we also test other invalid calls such as the auctioneer trying to claim the auction before it is over and a user attempting to bid once the auction is over."}),"\n",(0,a.jsx)(t.hr,{}),"\n",(0,a.jsx)(t.h2,{id:"executing-the-tests",children:"Executing the tests"}),"\n",(0,a.jsx)(t.p,{children:"Now that we understand what we are testing, let's go ahead and run the tests!"}),"\n",(0,a.jsxs)(r.Z,{groupId:"code-tabs",children:[(0,a.jsx)(i.Z,{value:"js",label:"\ud83c\udf10 JavaScript",children:(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"# if you haven't already, install the dependencies\nnpm install\n\n# run the tests\nnpm run test \n"})})}),(0,a.jsx)(i.Z,{value:"rust",label:"\ud83e\udd80 Rust",children:(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-bash",children:"cargo test\n"})})})]}),"\n",(0,a.jsxs)(t.p,{children:["All tests should pass, and you should see the output of the tests in the console. If you see any errors, please contact us in the ",(0,a.jsx)(t.a,{href:"https://near.chat",children:"NEAR Discord"})," or through ",(0,a.jsx)(t.a,{href:"https://t.me/neardev",children:"Telegram"})," and we'll help you out!"]}),"\n",(0,a.jsx)(t.hr,{}),"\n",(0,a.jsx)(t.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,a.jsx)(t.p,{children:"In this part of the tutorial, we've seen how to use our sandbox testing environment to test the contract. We've tested the contract's initialization, bidding, and time advancement."}),"\n",(0,a.jsxs)(t.p,{children:["You are now ready to move to the ",(0,a.jsx)(t.a,{href:"/tutorials/auction/deploy",children:"next section"}),", where we will deploy the contract to ",(0,a.jsx)(t.code,{children:"testnet"})," and interact with it through the CLI."]})]})}function b(e={}){const{wrapper:t}={...(0,s.a)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(p,{...e})}):p(e)}},85162:(e,t,n)=>{n.d(t,{Z:()=>i});n(67294);var a=n(36905);const s={tabItem:"tabItem_Ymn6"};var r=n(85893);function i(e){var t=e.children,n=e.hidden,i=e.className;return(0,r.jsx)("div",{role:"tabpanel",className:(0,a.Z)(s.tabItem,i),hidden:n,children:t})}},74866:(e,t,n)=>{n.d(t,{Z:()=>y});var a=n(67294),s=n(36905),r=n(12466),i=n(16550),o=n(20469),c=n(91980),l=n(67392),u=n(20812);function d(e){var t,n;return null!=(t=null==(n=a.Children.toArray(e).filter((function(e){return"\n"!==e})).map((function(e){if(!e||(0,a.isValidElement)(e)&&((t=e.props)&&"object"==typeof t&&"value"in t))return e;var t;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})))?void 0:n.filter(Boolean))?t:[]}function h(e){var t=e.values,n=e.children;return(0,a.useMemo)((function(){var e=null!=t?t:function(e){return d(e).map((function(e){var t=e.props;return{value:t.value,label:t.label,attributes:t.attributes,default:t.default}}))}(n);return function(e){var t=(0,l.lx)(e,(function(e,t){return e.value===t.value}));if(t.length>0)throw new Error('Docusaurus error: Duplicate values "'+t.map((function(e){return e.value})).join(", ")+'" found in <Tabs>. Every value needs to be unique.')}(e),e}),[t,n])}function p(e){var t=e.value;return e.tabValues.some((function(e){return e.value===t}))}function b(e){var t=e.queryString,n=void 0!==t&&t,s=e.groupId,r=(0,i.k6)(),o=function(e){var t=e.queryString,n=void 0!==t&&t,a=e.groupId;if("string"==typeof n)return n;if(!1===n)return null;if(!0===n&&!a)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return null!=a?a:null}({queryString:n,groupId:s});return[(0,c._X)(o),(0,a.useCallback)((function(e){if(o){var t=new URLSearchParams(r.location.search);t.set(o,e),r.replace(Object.assign({},r.location,{search:t.toString()}))}}),[o,r])]}function m(e){var t,n,s,r,i=e.defaultValue,c=e.queryString,l=void 0!==c&&c,d=e.groupId,m=h(e),g=(0,a.useState)((function(){return function(e){var t,n=e.defaultValue,a=e.tabValues;if(0===a.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!p({value:n,tabValues:a}))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+n+'" but none of its children has the corresponding value. Available values are: '+a.map((function(e){return e.value})).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");return n}var s=null!=(t=a.find((function(e){return e.default})))?t:a[0];if(!s)throw new Error("Unexpected error: 0 tabValues");return s.value}({defaultValue:i,tabValues:m})})),f=g[0],x=g[1],v=b({queryString:l,groupId:d}),j=v[0],w=v[1],y=(t=function(e){return e?"docusaurus.tab."+e:null}({groupId:d}.groupId),n=(0,u.Nk)(t),s=n[0],r=n[1],[s,(0,a.useCallback)((function(e){t&&r.set(e)}),[t,r])]),k=y[0],E=y[1],I=function(){var e=null!=j?j:k;return p({value:e,tabValues:m})?e:null}();return(0,o.Z)((function(){I&&x(I)}),[I]),{selectedValue:f,selectValue:(0,a.useCallback)((function(e){if(!p({value:e,tabValues:m}))throw new Error("Can't select invalid tab value="+e);x(e),w(e),E(e)}),[w,E,m]),tabValues:m}}var g=n(72389);const f={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var x=n(85893);function v(e){var t=e.className,n=e.block,a=e.selectedValue,i=e.selectValue,o=e.tabValues,c=[],l=(0,r.o5)().blockElementScrollPositionUntilNextRender,u=function(e){var t=e.currentTarget,n=c.indexOf(t),s=o[n].value;s!==a&&(l(t),i(s))},d=function(e){var t,n=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":var a,s=c.indexOf(e.currentTarget)+1;n=null!=(a=c[s])?a:c[0];break;case"ArrowLeft":var r,i=c.indexOf(e.currentTarget)-1;n=null!=(r=c[i])?r:c[c.length-1]}null==(t=n)||t.focus()};return(0,x.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,s.Z)("tabs",{"tabs--block":n},t),children:o.map((function(e){var t=e.value,n=e.label,r=e.attributes;return(0,x.jsx)("li",Object.assign({role:"tab",tabIndex:a===t?0:-1,"aria-selected":a===t,ref:function(e){return c.push(e)},onKeyDown:d,onClick:u},r,{className:(0,s.Z)("tabs__item",f.tabItem,null==r?void 0:r.className,{"tabs__item--active":a===t}),children:null!=n?n:t}),t)}))})}function j(e){var t=e.lazy,n=e.children,r=e.selectedValue,i=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){var o=i.find((function(e){return e.props.value===r}));return o?(0,a.cloneElement)(o,{className:(0,s.Z)("margin-top--md",o.props.className)}):null}return(0,x.jsx)("div",{className:"margin-top--md",children:i.map((function(e,t){return(0,a.cloneElement)(e,{key:t,hidden:e.props.value!==r})}))})}function w(e){var t=m(e);return(0,x.jsxs)("div",{className:(0,s.Z)("tabs-container",f.tabList),children:[(0,x.jsx)(v,Object.assign({},t,e)),(0,x.jsx)(j,Object.assign({},t,e))]})}function y(e){var t=(0,g.Z)();return(0,x.jsx)(w,Object.assign({},e,{children:d(e.children)}),String(t))}},71183:(e,t,n)=>{n.d(t,{O2:()=>b,Ey:()=>g,SQ:()=>m});var a=n(67294),s=n(74866),r=n(85162),i=n(74165),o=n(15861),c=n(1841),l=n.n(c),u=n(85893);function d(){return(d=(0,o.Z)((0,i.Z)().mark((function e(t,n,a){var s,r,o,c;return(0,i.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!((r=localStorage.getItem(t+"-until"))&&r>Date.now())){e.next=5;break}s=localStorage.getItem(t),e.next=18;break;case 5:return e.prev=5,e.next=8,fetch(t);case 8:return e.next=10,e.sent.text();case 10:s=e.sent,localStorage.setItem(t,s),localStorage.setItem(t+"-until",Date.now()+6e4),e.next=18;break;case 15:return e.prev=15,e.t0=e.catch(5),e.abrupt("return","Error fetching code, please try reloading");case 18:return o=s.split("\n"),n=n?Number(n)-1:0,a=a?Number(a):o.length,o=o.slice(n,a),c=o.reduce((function(e,t){if(0===t.length)return e;var n=t.match(/^\s+/);return n?Math.min(e,n[0].length):0}),1/0),e.abrupt("return",o.map((function(e){return e.slice(c)})).join("\n"));case 24:case"end":return e.stop()}}),e,null,[[5,15]])})))).apply(this,arguments)}const h=function(e){var t=e.url,n=e.start,s=e.end,r=e.language,i=e.fname,o=e.metastring,c=(0,a.useState)("Loading..."),h=c[0],p=c[1];return(0,a.useEffect)((function(){var e=function(e){var t=e.slice(e.indexOf("https")).split("#"),n=t[0],a=(t[1],new URL(n).pathname.split("/").slice(1)),s=a[0],r=a[1];return a[2],"https://raw.githubusercontent.com/"+s+"/"+r+"/"+a[3]+"/"+a.slice(4).join("/")}(t),a=function(e,t,n){return d.apply(this,arguments)}(e,n,s);a.then((function(e){return p(e)}))})),(0,u.jsxs)("div",{fname:i,children:[(0,u.jsx)(l(),{language:r,metastring:o+" showLineNumbers",children:h}),(0,u.jsx)("div",{style:{fontSize:"0.9em",fontWeight:600,color:"rgb(14, 117, 221)",textAlign:"center",paddingBottom:"13px",textDecoration:"underline"},children:(0,u.jsx)("a",{href:t,target:"_blank",rel:"noreferrer noopener",children:"See full example on GitHub"})})]})};var p={rust:"\ud83e\udd80 Rust",js:"\ud83c\udf10 Javascript",ts:"\ud83c\udf10 Typescript"};function b(e){var t=e.children;return Array.isArray(t)||(t=[t]),(0,u.jsx)(s.Z,{className:"language-tabs",groupId:"code-tabs",children:t.map((function(e,t){return(0,u.jsx)(r.Z,{value:e.props.value,label:p[e.props.value],children:e})}))})}function m(e){var t=e.children,n=e.language,a=e.showSingleFName;return Array.isArray(t)||(t=[t]),t=t.map((function(e){return function(e,t){var n=e.props,a=(n.children,n.url),s=n.start,r=n.end,i=n.fname;if(e.type===g)return g({url:a,start:s,end:r,language:t,fname:i});return e}(e,n)})),1!=t.length||a?(0,u.jsx)(s.Z,{className:"file-tabs",children:t.map((function(e,t){return(0,u.jsx)(r.Z,{value:t,label:e.props.fname,children:e})}))}):(0,u.jsx)(r.Z,{value:0,label:t[0].props.fname,children:t[0]})}function g(e){var t=e.url,n=e.start,a=e.end,s=e.language,r=e.fname,i=e.metastring;return h({url:t,start:n,end:a,language:s,fname:r,metastring:i})}}}]);