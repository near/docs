import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import { LantstoolLabel } from '@site/src/components/lantstool/LantstoolLabel/LantstoolLabel';
import { TryOutOnLantstool } from '@site/src/components/lantstool/TryOutOnLantstool';
import ErrorSchemaDescription from '../../_general/error-schema-description.mdx';

## Changes in Block {#changes-in-block}

> Returns changes in block for given block height or hash. You can also use
> `finality` param to return latest block details.

**Note**: You may choose to search by a specific block _or_ finality, you can not choose both.

- method: `EXPERIMENTAL_changes_in_block`
- params:
  - [`finality`](/api/rpc/setup#using-finality-param) _OR_ [`block_id`](/api/rpc/setup#using-block_id-param)

`finality` example:

<Tabs groupId="code-tabs">
  <TabItem value="json" label="JSON" default>
      ```json
      {
        "jsonrpc": "2.0",
        "id": "dontcare",
        "method": "EXPERIMENTAL_changes_in_block",
        "params": {
          "finality": "final"
        }
      }
      ```
  </TabItem>
  <TabItem value="js" label="JavaScript">
      ```js
      const response = await near.connection.provider.blockChanges({
        finality: 'final',
      });
      ```
  </TabItem>
  <TabItem value="http" label="HTTPie">
      ```bash
      http POST https://rpc.testnet.near.org \
        jsonrpc=2.0 \
        id=dontcare \
        method=EXPERIMENTAL_changes_in_block \
        params:='{
          "finality": "final"
        }'
      ```
  </TabItem>
  <TabItem value="Lantstool" label={<LantstoolLabel />}>
    <TryOutOnLantstool path="docs/5.api/rpc/block-chunk/get-latest-block-changes.json" />
  </TabItem>
</Tabs>

`block_height` example:

<Tabs groupId="code-tabs">
  <TabItem value="json" label="JSON" default>
      ```json
      {
        "jsonrpc": "2.0",
        "id": "dontcare",
        "method": "EXPERIMENTAL_changes_in_block",
        "params": {
          "block_id": 187310138
        }
      }
      ```
  </TabItem>
  <TabItem value="js" label="JavaScript">
      ```js
      const response = await near.connection.provider.blockChanges({
        blockId: 187310138,
      });
      ```
  </TabItem>
  <TabItem value="http" label="HTTPie">
      ```bash
      http POST https://archival-rpc.testnet.near.org \
        jsonrpc=2.0 \
        id=dontcare \
        method=EXPERIMENTAL_changes_in_block \
        params:='{
          "block_id": 187310138
        }'
      ```
  </TabItem>
  <TabItem value="Lantstool" label={<LantstoolLabel />}>
    <TryOutOnLantstool path="docs/5.api/rpc/block-chunk/get-block-changes-by-block-height.json" />
  </TabItem>
</Tabs>

`block_hash` example:

<Tabs groupId="code-tabs">
  <TabItem value="json" label="JSON" default>
      ```json
      {
        "jsonrpc": "2.0",
        "id": "dontcare",
        "method": "EXPERIMENTAL_changes_in_block",
        "params": {
          "block_id": "6RWmTYhXCzjMjoY3Mz1rfFcnBm8E6XeDDbFEPUA4sv1w"
        }
      }
      ```
  </TabItem>
  <TabItem value="js" label="JavaScript">
      ```js
      const response = await near.connection.provider.blockChanges({
        blockId: '6RWmTYhXCzjMjoY3Mz1rfFcnBm8E6XeDDbFEPUA4sv1w',
      });
      ```
  </TabItem>
  <TabItem value="http" label="HTTPie">
      ```bash
      http POST https://archival-rpc.testnet.near.org \
        jsonrpc=2.0 \
        id=dontcare \
        method=EXPERIMENTAL_changes_in_block \
        params:='{
          "block_id": "6RWmTYhXCzjMjoY3Mz1rfFcnBm8E6XeDDbFEPUA4sv1w"
        }'
      ```
  </TabItem>
  <TabItem value="Lantstool" label={<LantstoolLabel />}>
    <TryOutOnLantstool path="docs/5.api/rpc/block-chunk/get-block-changes-by-block-hash.json" />
  </TabItem>
</Tabs>

<details>
  <summary>Example response: </summary>
    ```json
    {
      "jsonrpc": "2.0",
      "result": {
        "block_hash": "6RWmTYhXCzjMjoY3Mz1rfFcnBm8E6XeDDbFEPUA4sv1w",
        "changes": [
          {
            "account_id": "account.rpc-examples.testnet",
            "type": "account_touched"
          },
          {
            "account_id": "dev2-nsp.testnet",
            "type": "account_touched"
          },
          {
            "account_id": "ping-account.testnet",
            "type": "account_touched"
          },
          {
            "account_id": "v1.signer-dev.testnet",
            "type": "account_touched"
          },
          {
            "account_id": "account.rpc-examples.testnet",
            "type": "access_key_touched"
          },
          {
            "account_id": "ping-account.testnet",
            "type": "access_key_touched"
          },
          {
            "account_id": "dev2-nsp.testnet",
            "type": "data_touched"
          },
          {
            "account_id": "dev2-nsp.testnet",
            "type": "data_touched"
          },
          {
            "account_id": "v1.signer-dev.testnet",
            "type": "data_touched"
          }
        ]
      },
      "id": "dontcare"
    }
    ```
</details>

#### What Could Go Wrong? {#what-could-go-wrong-1}

<ErrorSchemaDescription />

Here is the exhaustive list of the error variants that can be returned by
`EXPERIMENTAL_changes_in_block` method:

<table className="custom-stripe">
  <thead>
    <tr>
      <th>
        ERROR_TYPE
        <br />
        <code>error.name</code>
      </th>
      <th>
        ERROR_CAUSE
        <br />
        <code>error.cause.name</code>
      </th>
      <th>Status Code</th>
      <th>Reason</th>
      <th>Solution</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td rowspan="2">HANDLER_ERROR</td>
      <td>UNKNOWN_BLOCK</td>
      <td>200</td>
      <td>
        The requested block has not been produced yet or it has been garbage-collected (cleaned up
        to save space on the RPC node)
      </td>
      <td>
        <ul>
          <li>Check that the requested block is legit</li>
          <li>
            If the block had been produced more than 5 epochs ago, try to send your request to{' '}
            <a
              href="https://near-nodes.io/intro/node-types#archival-node"
              target="_blank"
              rel="noopener noreferrer"
            >
              an archival node
            </a>
          </li>
        </ul>
      </td>
    </tr>
    <tr>
      <td>NOT_SYNCED_YET</td>
      <td>200</td>
      <td>The node is still syncing and the requested block is not in the database yet</td>
      <td>
        <ul>
          <li>Wait until the node finish syncing</li>
          <li>Send a request to a different node which is synced</li>
        </ul>
      </td>
    </tr>
    <tr className="stripe">
      <td>REQUEST_VALIDATION_ERROR</td>
      <td>PARSE_ERROR</td>
      <td>400</td>
      <td>
        Passed arguments can't be parsed by JSON RPC server (missing arguments, wrong format, etc.)
      </td>
      <td>
        <ul>
          <li>Check the arguments passed and pass the correct ones</li>
          <li>
            Check <code>error.cause.info</code> for more details
          </li>
        </ul>
      </td>
    </tr>
    <tr>
      <td>INTERNAL_ERROR</td>
      <td>INTERNAL_ERROR</td>
      <td>500</td>
      <td>Something went wrong with the node itself or overloaded</td>
      <td>
        <ul>
          <li>Try again later</li>
          <li>Send a request to a different node</li>
          <li>
            Check <code>error.cause.info</code> for more details
          </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
